<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥dulo STEM: CLI de Respuesta a Incidente</title>

    <style>
        /* Variables de colores modernos */
        :root {
            --primary-blue: #0A1128;
            --secondary-blue: #034078;
            --accent-green: #2BBD84;
            --light-bg: #F8F9FA;
            --dark-bg: #212529;
            --text-light: #E0FBFC;
            --text-dark: #333;
            --panel-border: #016FB9;
            --terminal-green: #00FF41;
            --gradient-btn-start: #007bff;
            --gradient-btn-end: #0056b3;
            --gradient-btn-hover-start: #0056b3;
            --gradient-btn-hover-end: #003d80;
            --danger-red: #DC3545;
            --warning-orange: #FD7E14;
        }

        body {
            display: grid;
            grid-template-columns: 320px auto 400px;
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background: linear-gradient(to right bottom, #f0f8ff, #e0f2f7);
            height: 100vh;
            overflow: hidden;
            color: var(--text-dark);
        }

        /* Paneles Laterales */
        #panel-acciones, #panel-didactico {
            background: var(--light-bg);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid var(--panel-border);
            border-right: 1px solid var(--panel-border);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
        }

        /* √Årea de Simulaci√≥n Central (Visor de Sistema) */
        #area-simulacion {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 20px;
            text-align: center;
            overflow-y: auto;
        }

        #visor-sistema {
            background: var(--dark-bg);
            color: var(--terminal-green);
            border: 3px solid var(--primary-blue);
            border-radius: 8px;
            padding: 25px;
            margin: 20px 0;
            width: 90%;
            height: 400px;
            text-align: left;
            overflow-y: scroll;
            font-family: 'Fira Code', 'Consolas', 'Courier New', monospace;
            font-size: 0.95em;
            box-shadow: inset 0 0 8px rgba(0, 255, 65, 0.3);
        }
        
        /* Indicadores de Gamificaci√≥n */
        #indicadores {
            width: 90%;
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.1em;
        }
        .indicador {
            padding: 12px 18px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background: #eef7fb;
            color: var(--secondary-blue);
        }
        #puntuacion { background: #ffe0b2; color: var(--warning-orange); }
        #tiempo-restante { background: #b2ebf2; color: var(--gradient-btn-start); }
        .danger { background: var(--danger-red) !important; color: var(--text-light) !important; }

        /* Estilos para la nueva din√°mica de selecci√≥n */
        #selector-comando {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        #comando-select {
            padding: 10px 12px;
            flex-grow: 1;
            border: 1px solid #ced4da;
            border-radius: 5px;
            background-color: #fff;
            color: var(--text-dark);
            font-size: 0.9em;
        }

        /* Estilo de los bloques */
        .comando-en-lista {
            padding: 10px 15px;
            margin: 8px 0;
            background: var(--accent-green);
            color: var(--text-light);
            border-radius: 6px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .btn-eliminar-comando {
            background: var(--danger-red);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background 0.2s;
        }
        .btn-eliminar-comando:hover {
            background: #c82333;
        }

        #programa-accion {
            min-height: 200px;
            border: 2px dashed var(--panel-border);
            margin-top: 15px;
            padding: 15px;
            background: #fdfdfd;
            border-radius: 8px;
        }

        /* Botones y Selectores */
        button {
            margin: 7px 0;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s ease;
            color: white;
            background: linear-gradient(145deg, var(--gradient-btn-start), var(--gradient-btn-end));
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%; /* Asegura que los botones de control ocupen todo el ancho */
        }
        button:hover {
            background: linear-gradient(145deg, var(--gradient-btn-hover-start), var(--gradient-btn-hover-end));
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-run { background: linear-gradient(145deg, #28a745, #218838); }
        .btn-run:hover { background: linear-gradient(145deg, #218838, #1e7e34); }
        .btn-clear { background: linear-gradient(145deg, #ffc107, #e0a800); color: var(--text-dark); }
        .btn-clear:hover { background: linear-gradient(145deg, #e0a800, #c69500); }
        .btn-reset { background: linear-gradient(145deg, #17a2b8, #138496); }
        .btn-reset:hover { background: linear-gradient(145deg, #138496, #0f6674); }
        .btn-ayuda { 
            background: linear-gradient(145deg, #6c757d, #5a6268); 
            color: var(--text-light); 
            margin-top: 15px;
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            font-weight: bold;
        }
        .btn-ayuda:hover { background: linear-gradient(145deg, #5a6268, #494f54); }
        
        /* Estilo espec√≠fico para el bot√≥n de A√±adir Secuencia (en el flexbox) */
        .btn-add-command {
            background: linear-gradient(145deg, var(--accent-green), #219973);
            font-weight: bold;
            padding: 10px 15px;
            margin: 0;
            width: auto; /* Permite que este bot√≥n sea m√°s peque√±o */
        }
        .btn-add-command:hover {
            background: linear-gradient(145deg, #219973, #1e8564);
        }

        #nivel-selector {
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid #ced4da;
            margin-top: 10px;
            width: 100%;
            background-color: #fff;
            color: var(--text-dark);
            font-size: 0.9em;
        }

        h2, h3, h4 { color: var(--primary-blue); margin-bottom: 10px; }
        h2 { font-size: 1.8em; margin-bottom: 20px; }
        h3 { font-size: 1.4em; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 8px; margin-top: 25px; }
        h4 { font-size: 1.1em; margin-top: 20px;}

        /* Estilos del panel Did√°ctico */
        #desafio-actual, #contenido-teorico {
            margin-top: 15px; padding: 18px; border-radius: 8px; background: #e0f2f7; border: 1px solid #cceeff; font-size: 0.9em;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .objetivo-aprendizaje {
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--secondary-blue);
            line-height: 1.5;
        }
        .objetivo-aprendizaje::before {
            content: '‚û§ ';
            color: var(--accent-green);
            font-weight: bold;
            margin-right: 5px;
        }

        /* Estilos para el MODAL de AYUDA */
        #modal-ayuda {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            background-color: var(--light-bg);
            margin: 5% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 900px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            color: var(--text-dark);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        .close-button:hover,
        .close-button:focus {
            color: var(--danger-red);
            text-decoration: none;
        }
        .modal-content h3 { color: var(--danger-red); margin-top: 25px; }
        .modal-content h4 { border-bottom: 2px solid var(--secondary-blue); padding-bottom: 5px; margin-top: 20px; color: var(--secondary-blue); }
        .modal-content ul { list-style-type: disc; margin-left: 20px; }
        .modal-content li { margin-bottom: 8px; }

        /* Mejora del contenido te√≥rico en detalles */
        #contenido-teorico details {
            margin-top: 12px;
            border: 1px solid #D1D8E0;
            padding: 12px;
            border-radius: 6px;
            background: #FFFFFF;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        #contenido-teorico summary {
            cursor: pointer;
            font-weight: 600;
            color: var(--primary-blue);
            padding: 5px 0;
            outline: none;
        }
        #contenido-teorico summary:hover {
            color: var(--secondary-blue);
        }
        #contenido-teorico p {
            margin-top: 10px;
            line-height: 1.6;
            color: #555;
        }

    </style>
</head>
<body>

    <div id="modal-ayuda">
        <div class="modal-content">
            <span class="close-button" onclick="toggleModal()">√ó</span>
            <h2>üõ°Ô∏è Fundamentos de Ataques y Respuesta (STEM)</h2>
            
            <p>Comprender los tipos de incidentes de seguridad y el orden estrat√©gico de respuesta es fundamental en la **Ingenier√≠a de Ciberseguridad**.</p>
            
            <hr style="border-color: #eee; margin: 25px 0;">

            <h3>Tipos de Incidentes (Ciencia y Tecnolog√≠a)</h3>
            
            <h4>Phishing</h4>
            <p>T√©cnica de **ingenier√≠a social** utilizada para enga√±ar a los usuarios y obtener informaci√≥n confidencial (credenciales, datos bancarios). La amenaza suele ser simple y el foco es la recuperaci√≥n y limpieza del sistema afectado.</p>
            
            <h4>Ransomware</h4>
            <p>Software malicioso que **cifra los archivos** de un sistema o red, exigiendo un pago (rescate) para su liberaci√≥n. La prioridad es la **contenci√≥n**, la **recuperaci√≥n de datos** a partir de copias de seguridad y la **notificaci√≥n**.</p>

            <h4>Zero-Day</h4>
            <p>Explotaci√≥n de una **vulnerabilidad de software desconocida** para el fabricante, sin parches disponibles. Requiere una respuesta r√°pida y precisa, donde la **recolecci√≥n de evidencia forense** es cr√≠tica antes de cualquier limpieza para analizar la amenaza y desarrollar soluciones.</p>
            
            <hr style="border-color: #eee; margin: 25px 0;">

            <h3>Principios de Respuesta a Incidentes (Matem√°ticas e Ingenier√≠a)</h3>
            <ul>
                <li>**Contenci√≥n:** Aislar el sistema o la red afectada para detener la propagaci√≥n del incidente y minimizar el da√±o. Implica decisiones r√°pidas y estrat√©gicas.</li>
                <li>**Erradicaci√≥n y Recuperaci√≥n:** Eliminar la causa ra√≠z del incidente y restaurar los sistemas a un estado operativo seguro. Es crucial diferenciar entre limpiar y la necesidad de **evidencia forense**.</li>
                <li>**An√°lisis Post-Incidente:** Estudio detallado del ataque para comprender c√≥mo ocurri√≥, qu√© sistemas se vieron afectados y c√≥mo prevenir futuros incidentes. Aqu√≠ la **evidencia** es de valor cient√≠fico y de ingenier√≠a.</li>
            </ul>

            <button class="btn-reset" onclick="toggleModal()" style="width:100%; margin-top:20px; background: var(--secondary-blue);">Cerrar y Volver a la Simulaci√≥n</button>
        </div>
    </div>

    <div id="panel-acciones">
        <h2>üõ†Ô∏è Interfaz de Comandos CLI</h2>
        
        <h3>Tipo de Incidente</h3>
        <select id="nivel-selector" onchange="resetSimulacion()">
            <option value="1">Phishing</option>
            <option value="2" selected>Ransomware</option>
            <option value="3">Zero-Day</option>
        </select>
        
        <div id="indicadores">
            <div id="puntuacion" class="indicador">Puntos: 0</div>
            <div id="tiempo-restante" class="indicador">Tiempo Restante: 100%</div>
        </div>

        <h3>A√±adir Comando</h3>
        <div id="selector-comando">
            <select id="comando-select">
                <option value="Desconectar de la Red">Desconectar de la Red</option>
                <option value="Recopilar Evidencia (Forensic)">Recopilar Evidencia (Forensic)</option>
                <option value="Formatear Disco Duro (Limpieza)">Formatear Disco Duro (Limpieza)</option>
                <option value="Restaurar Backup">Restaurar Backup</option>
                <option value="Notificar Incidente a Autoridad">Notificar Incidente a Autoridad</option>
                <option value="Ejecutar Antivirus R√°pido">Ejecutar Antivirus R√°pido</option>
            </select>
            <button onclick="addCommand()" class="btn-add-command">A√±adir</button>
        </div>
        
        <button class="btn-run" onclick="runProgram()">‚ñ∂ Ejecutar Secuencia</button>
        <button class="btn-clear" onclick="clearProgram()">üßπ Borrar Secuencia</button>
        <button class="btn-reset" onclick="resetSimulacion()">üîÑ Reiniciar Incidente</button>

        <h4>Secuencia de Ejecuci√≥n</h4>
        <div id="programa-accion">
            </div>
    </div>

    <div id="area-simulacion">
        <h1>Simulador STEM: Respuesta a Incidentes de Ciberseguridad</h1>
        <p id="descripcion-nivel">Selecciona un tipo de incidente para comenzar el desaf√≠o.</p>
        
        <div id="visor-sistema">
            <span id="terminal-output">
                > System Log: Iniciando m√≥dulo de seguridad...<br>
            </span>
        </div>

        <div id="feedback-status" class="indicador">
            Define tu plan de respuesta para mitigar el ataque.
        </div>
    </div>

    <div id="panel-didactico">
        <h2>üìö Unidad Did√°ctica STEM</h2>
        
        <button class="btn-ayuda" onclick="toggleModal()">‚ùî Explicaci√≥n de Ciberseguridad</button>

        <div id="desafio-actual">
            <h4>üéØ Desaf√≠o Actual: <span id="nombre-desafio"></span></h4>
            <p id="explicacion-desafio"></p>
            
            <h3>Objetivos de Aprendizaje</h3>
            <div class="objetivo-aprendizaje">Aplicar la **Contenci√≥n** como primera l√≠nea de defensa.</div>
            <div class="objetivo-aprendizaje">**Optimizar la secuencia** de comandos para minimizar el da√±o y el tiempo.</div>
            <div class="objetivo-aprendizaje">**Priorizar la recolecci√≥n de evidencia** forense seg√∫n el tipo de ataque.</div>
            <div class="objetivo-aprendizaje">Cumplir con los protocolos de **Notificaci√≥n Legal** (Ciudadan√≠a Digital).</div>
        </div>

        <div id="contenido-teorico">
            <h3>Acciones en Detalle (Fundamentos)</h3>
            <details>
                <summary>Desconectar de la Red</summary>
                <p>Corta la comunicaci√≥n del sistema infectado con la red externa e interna, previniendo la propagaci√≥n del malware.</p>
            </details>
            <details>
                <summary>Recopilar Evidencia (Forensic)</summary>
                <p>Recoge datos del sistema comprometido (registros, im√°genes de disco) para analizar el incidente y entender c√≥mo ocurri√≥.</p>
            </details>
            <details>
                <summary>Formatear Disco Duro (Limpieza)</summary>
                <p>Borra completamente el contenido del disco, eliminando el malware y dejando el sistema listo para una instalaci√≥n limpia.</p>
            </details>
            <details>
                <summary>Restaurar Backup</summary>
                <p>Recupera los datos y sistemas a un estado anterior al incidente usando copias de seguridad confiables.</p>
            </details>
            <details>
                <summary>Notificar Incidente a Autoridad</summary>
                <p>Informa a las autoridades o equipos de seguridad pertinentes sobre el ciberataque, cumpliendo con protocolos de ciudadan√≠a digital.</p>
            </details>
            <details>
                <summary>Ejecutar Antivirus R√°pido</summary>
                <p>Realiza un escaneo r√°pido del sistema en busca de malware conocido. Es √∫til para amenazas b√°sicas, pero ineficaz contra ataques complejos (Zero-Day).</p>
            </details>
        </div>
    </div>

    <script>
        
        // =========================================================
        // === FUNCI√ìN CR√çTICA DE A√ëADIR COMANDO (REFORZADA) ===
        // =========================================================
        window.addCommand = function() {
            // Depuraci√≥n: Confirma que la funci√≥n se ejecuta.
            console.log("DEBUG: addCommand() se ejecut√≥."); 

            const programaAccion = document.getElementById("programa-accion");
            const comandoSelect = document.getElementById("comando-select");

            if (!comandoSelect) {
                console.error("DEBUG ERROR: El SELECTOR de comandos (ID: comando-select) NO fue encontrado.");
                return;
            }
            if (!programaAccion) {
                console.error("DEBUG ERROR: El CONTENEDOR de acciones (ID: programa-accion) NO fue encontrado.");
                return;
            }

            const comando = comandoSelect.value;
            if (!comando) return; 

            // Creaci√≥n del bloque de comando
            const div = document.createElement("div");
            div.className = "comando-en-lista";
            div.setAttribute('data-command', comando); 
            div.setAttribute('draggable', 'true');
            div.innerHTML = `
                <span>> ${comando}</span> 
                <button class="btn-eliminar-comando" onclick="this.parentNode.remove()">X</button>
            `;
            
            // Inserci√≥n en el contenedor
            programaAccion.appendChild(div);
            logToTerminal(`Comando A√±adido: ${comando}`);
            console.log("DEBUG √âXITO: Comando a√±adido al DOM y funci√≥n completada.");
        }
        // =========================================================

        document.addEventListener('DOMContentLoaded', (event) => {

            // ===================================================
            // === 1. CAPTURA DE ELEMENTOS (para funciones internas) ===
            // ===================================================
            const programaAccion = document.getElementById("programa-accion");
            const terminalOutput = document.getElementById("terminal-output");
            const puntuacionDiv = document.getElementById("puntuacion");
            const tiempoRestanteDiv = document.getElementById("tiempo-restante");
            const feedbackStatus = document.getElementById("feedback-status");
            const nivelSelector = document.getElementById("nivel-selector");
            const nombreDesafio = document.getElementById("nombre-desafio");
            const explicacionDesafio = document.getElementById("explicacion-desafio");
            const descripcionNivel = document.getElementById("descripcion-nivel");


            // ===================================================
            // === 2. VARIABLES DE ESTADO Y DEFINICIONES DE NIVEL ===
            // ===================================================
            let puntuacion = 0;
            let tiempo = 100; 
            let infectado = true;
            let evidenciaRecopilada = false;
            let nivelActual = 2; 

            // LAS ACCIONES USAN AHORA EL TEXTO SIN N√öMEROS
            const acciones = {
                "Desconectar de la Red": { costo: 5, correcto: true, mensaje: "Red Desconectada: Propagaci√≥n detenida. (CR√çTICO)", efecto: () => infectado = false },
                "Recopilar Evidencia (Forensic)": { costo: 15, correcto: true, mensaje: "Evidencia recopilada: Esto es clave para el an√°lisis futuro (Ciencia/Ingenier√≠a).", efecto: () => evidenciaRecopilada = true },
                "Formatear Disco Duro (Limpieza)": { costo: 10, correcto: true, mensaje: "Sistema formateado. La limpieza fue exitosa, pero ¬°cuidado con la evidencia!", efecto: null },
                "Restaurar Backup": { costo: 5, correcto: true, mensaje: "Backup restaurado. Datos recuperados con √©xito.", efecto: null },
                "Notificar Incidente a Autoridad": { costo: 5, correcto: false, mensaje: "Notificaci√≥n enviada. Esto es un requisito de Ciudadan√≠a Digital, pero no detiene la amenaza.", efecto: null },
                "Ejecutar Antivirus R√°pido": { costo: 10, correcto: false, mensaje: "Antivirus ejecutado. A menudo in√∫til contra amenazas nuevas, solo consume tiempo.", efecto: null }
            };

            const niveles = {
                "1": {
                    nombre: "Phishing",
                    explicacion: "El incidente de Phishing implica el robo de credenciales. Tu objetivo es eliminar la amenaza local y restaurar el acceso. La recopilaci√≥n forense avanzada no es prioritaria aqu√≠.",
                    terminal: "Acceso no autorizado por credenciales robadas. Actividad sospechosa de malware simple detectada.",
                    // ORDEN √ìPTIMO SIN N√öMEROS
                    orden_optimo: ["Desconectar de la Red", "Ejecutar Antivirus R√°pido", "Restaurar Backup"],
                    puntuacion_base: 50
                },
                "2": {
                    nombre: "Ransomware",
                    explicacion: "Un ataque de Ransomware ha cifrado archivos cr√≠ticos. Debes contener la infecci√≥n, recuperar la informaci√≥n vital mediante copias de seguridad y notificar el incidente. La evidencia forense es valiosa pero no siempre cr√≠tica en este nivel.",
                    terminal: "[ALERTA AMARILLA] Archivos de registro cifrados con ransomware. No hay evidencia de propagaci√≥n a otros sistemas.",
                    // ORDEN √ìPTIMO SIN N√öMEROS
                    orden_optimo: ["Desconectar de la Red", "Restaurar Backup", "Notificar Incidente a Autoridad"],
                    puntuacion_base: 100
                },
                "3": {
                    nombre: "Zero-Day",
                    explicacion: "Un ataque Zero-Day explota una vulnerabilidad desconocida, con r√°pida propagaci√≥n. La contenci√≥n (aislamiento), la recopilaci√≥n forense antes de cualquier limpieza y la restauraci√≥n son pasos CR√çTICOS y el orden es vital.",
                    terminal: "[ALERTA ROJA] Acceso no autorizado detectado en puerto 445 (SMB). Propagaci√≥n iniciada. ¬°ACT√öA AHORA!",
                    // ORDEN √ìPTIMO SIN N√öMEROS
                    orden_optimo: ["Desconectar de la Red", "Recopilar Evidencia (Forensic)", "Formatear Disco Duro (Limpieza)", "Restaurar Backup", "Notificar Incidente a Autoridad"],
                    puntuacion_base: 150
                }
            };


            // ==================================================
            // === 3. FUNCIONES PRINCIPALES (Expuestas al HTML) ===
            // ==================================================

            window.logToTerminal = function(text) {
                if(terminalOutput) {
                    terminalOutput.innerHTML += `<br>> ${new Date().toLocaleTimeString()} ${text}`;
                    terminalOutput.scrollTop = terminalOutput.scrollHeight; 
                }
            }

            function updateStatus(points, timeCost) {
                puntuacion += points;
                tiempo -= timeCost;
                tiempo = Math.max(0, tiempo);

                if(puntuacionDiv) puntuacionDiv.innerText = `Puntos: ${puntuacion}`;
                if(tiempoRestanteDiv) {
                    tiempoRestanteDiv.innerText = `Tiempo Restante: ${tiempo}%`;
                    tiempoRestanteDiv.classList.toggle('danger', tiempo <= 20);
                }
            }
            
            window.clearProgram = function() {
                if(programaAccion) programaAccion.innerHTML = "";
                logToTerminal("Secuencia de comandos borrada.");
            }

            window.runProgram = async function() {
                if (!programaAccion || !feedbackStatus) return; 
                if (tiempo <= 0) {
                    feedbackStatus.innerHTML = "‚ùå **FIN DEL JUEGO.** Te quedaste sin tiempo/recursos para actuar.";
                    return;
                }

                // Obtiene la secuencia actual del DOM
                const bloques = Array.from(programaAccion.querySelectorAll(".comando-en-lista")).map(div => div.getAttribute('data-command'));
                
                if (bloques.length === 0) {
                    feedbackStatus.innerHTML = "‚ö†Ô∏è **ERROR:** Debes a√±adir comandos a la secuencia para ejecutar el programa.";
                    logToTerminal("ERROR: Secuencia de ejecuci√≥n vac√≠a.");
                    return;
                }

                const nivel = niveles[nivelActual];
                let resultadoFinal = `Simulaci√≥n de ${nivel.nombre} terminada. Resultado: `;
                let puntosBaseGanados = 0;
                let ordenCorrecto = true;
                
                infectado = true;
                evidenciaRecopilada = false;

                for (let i = 0; i < bloques.length; i++) {
                    const cmd = bloques[i];
                    const action = acciones[cmd];
                    
                    if (!action) continue; 

                    updateStatus(0, action.costo);
                    logToTerminal(`Ejecutando: ${cmd}... Costo: ${action.costo}% de tiempo.`);
                    
                    if (action.efecto) action.efecto(); 
                    
                    // L√≥gica de Penalizaciones
                    if (nivelActual == 3) {
                        if (cmd === "Recopilar Evidencia (Forensic)" && infectado) {
                            updateStatus(-30, 0);
                            logToTerminal("‚ö†Ô∏è ¬°ERROR! Recopilar evidencia con el sistema a√∫n conectado puede comprometer las herramientas forenses. -30 Puntos.");
                            ordenCorrecto = false;
                        }
                        if (cmd === "Formatear Disco Duro (Limpieza)" && !evidenciaRecopilada) {
                            updateStatus(-50, 0);
                            logToTerminal("‚ùå ¬°CR√çTICO! Formateaste antes de recopilar evidencia. P√©rdida irrecuperable de datos forenses. -50 Puntos.");
                            ordenCorrecto = false;
                        }
                    }
                    
                    if (nivelActual == 1 && cmd === "Recopilar Evidencia (Forensic)") {
                        updateStatus(-10, 0);
                        logToTerminal("üí° El comando 'Recopilar Evidencia' es innecesario para un ataque simple. Es una p√©rdida de tiempo. -10 Puntos.");
                    }

                    await new Promise(resolve => setTimeout(resolve, 800));
                }

                // Evaluaci√≥n Final
                const bloquesEsenciales = nivel.orden_optimo.filter(b => bloques.includes(b));
                
                if (bloquesEsenciales.length >= nivel.orden_optimo.length) {
                    puntosBaseGanados = nivel.puntuacion_base;
                    resultadoFinal = `üèÜ **¬°INCIDENTE MITIGADO!** Respuesta eficiente al ${nivel.nombre}. Ganaste los puntos base (+${nivel.puntuacion_base}).`;
                    
                    let bloquesCortados = bloques.slice(0, nivel.orden_optimo.length);
                    if (ordenCorrecto && JSON.stringify(bloquesCortados) === JSON.stringify(nivel.orden_optimo)) {
                        updateStatus(50, 0);
                        resultadoFinal += " **¬°BONUS DE INGENIER√çA!** Orden √≥ptimo. +50 Puntos extra.";
                    }
                } else {
                    resultadoFinal = "‚ö†Ô∏è **INCIDENTE FALLIDO.** No se incluyeron todos los pasos esenciales para mitigar la amenaza.";
                }

                updateStatus(puntosBaseGanados, 0);
                feedbackStatus.innerHTML = resultadoFinal;
            }

            window.resetSimulacion = function() {
                if(!nivelSelector) return;
                nivelActual = nivelSelector.value;
                const nivel = niveles[nivelActual];

                puntuacion = 0;
                tiempo = 100;
                infectado = true;
                evidenciaRecopilada = false;
                
                updateStatus(0, 0); 
                
                if(nombreDesafio) nombreDesafio.textContent = nivel.nombre;
                if(explicacionDesafio) explicacionDesafio.innerHTML = nivel.explicacion;
                if(descripcionNivel) descripcionNivel.textContent = `Est√°s en el servidor corporativo. Tienes un ataque: ${nivel.nombre}.`;
                if(terminalOutput) terminalOutput.innerHTML = `> System Log: Iniciando Desaf√≠o ${nivelActual}...<br>> ${nivel.terminal}`;
                if(feedbackStatus) feedbackStatus.innerHTML = `Define tu plan de respuesta para mitigar el ataque de **${nivel.nombre}**.`;
                clearProgram();
            }

            window.toggleModal = function() {
                const modalAyuda = document.getElementById("modal-ayuda");
                if(modalAyuda) {
                    modalAyuda.style.display = (modalAyuda.style.display === "block") ? "none" : "block";
                }
            }

            window.onclick = function(event) {
                const modalAyuda = document.getElementById("modal-ayuda");
                if (event.target == modalAyuda) {
                    toggleModal();
                }
            }
            
            // Inicializa la simulaci√≥n al final de la carga del DOM
            resetSimulacion();
        });
    </script>
</body>
</html>